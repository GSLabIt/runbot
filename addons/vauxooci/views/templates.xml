<openerp>
    <data>
        <template id="runbot.build_name">
            <t t-set="klass_column" t-value="'col-md-8 col-sm-8 col-xs-8'"/>
            <div t-attf-class="{{klass_column}}" t-if="bu['state']=='pending'">
                <i class="material-icons">pause</i>
                <h5><t t-esc="bu['dest']"/></h5>
            </div>
            <div t-attf-class="{{klass_column}}" t-if="bu['state']=='testing'">
                <i class="material-icons">cached</i>
                <h5><t t-esc="bu['dest']"/></h5>
            </div>
            <div t-attf-class="{{klass_column}}" t-if="bu['result']=='ok'">
                <i class="material-icons">thumb_up</i>
                <h5><t t-esc="bu['dest']"/></h5>
            </div>
            <div t-attf-class="{{klass_column}}" t-if="bu['result']=='ko'">
                <i class="material-icons">bug_report</i>
                <h5><t t-esc="bu['dest']"/></h5>
            </div>
            <div t-attf-class="{{klass_column}}" t-if="bu['result']=='warn'">
                <i class="material-icons">warning</i>
                <h5><t t-esc="bu['dest']"/></h5>
            </div>
            <div t-attf-class="{{klass_column}}" t-if="bu['result']=='skipped'">
                <i class="material-icons">block</i>
                <h5><t t-esc="bu['dest']"/></h5>
            </div>
            <div t-attf-class="{{klass_column}}" t-if="bu['result']=='killed'">
                <i class="material-icons">sync_problem</i>
                <h5><t t-esc="bu['dest']"/></h5>
            </div>
            <div t-attf-class="{{klass_column}}" t-if="not bu['result'] and not bu['state']=='testing'">
                <i class="material-icons">error</i>
                <h5><t t-esc="bu['dest']"/></h5>
            </div>
            <t t-if="bu['server_match'] in ('default', 'fuzzy')">
                <i class="text-warning fa fa-question-circle fa-fw"
                   title="Server branch cannot be determined exactly. Please use naming convention '9.0-my-branch' to build with '9.0' server branch."/>
            </t>
        </template>
        <!-- TODO: Button to set the kill this and force rebuild with proper management.
             -->

        <template id="runbot.build_button">
            <div class="col-md-4">
            <div class="btn-group">
                <button t-attf-class="btn btn-fab btn-fab-mini dropdown-toggle btn-{{ klass }}" data-toggle="dropdown">
                    <t t-if="bu['committer'] and bu['author'] == bu['committer']">
                        <i class="material-icons">person</i>
                    </t>
                    <t t-if="bu['committer'] and bu['author'] != bu['committer']">
                        <i class="material-icons">people</i>
                    </t>
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu">
                    <li class="dropdown-header">Authors</li>
                    <li class="disabled">
                        <a href="#" t-id="bu['author']"><small>Author:</small><t t-esc="bu['author']"/></a>
                    </li>
                    <li class="disabled" t-if="bu['committer'] and bu['author'] != bu['committer']">
                        <a href="#" t-id="bu['committer']"><small>Committed by:</small> <t t-esc="bu['committer']"/></a>
                    </li>
                    <li t-if="bu['state']!='testing' and bu['state']!='pending'" class="divider"></li>
                    <li class="dropdown-header">Information</li>
                    <li class="disabled"><a href="#">Runtime: <t t-esc="bu['job_time']"/>s</a></li>
                    <li class="disabled"><a href="#">Port: <t t-esc="bu['port']"/></a></li>
                    <li class="disabled"><a href="#">Age: <t t-esc="bu['job_age']"/></a></li>
                </ul>
            </div>
            <div class="btn-group">
                <button t-attf-class="btn btn-fab btn-fab-mini dropdown-toggle btn-{{klass}}" data-toggle="dropdown">
                    <t t-if="bu['state']=='running'"><i class="material-icons">ondemand_video</i> </t> <t t-if="bu['state']!='running'"><i class="material-icons">settings</i></t> <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu">
                    <t t-if="bu['state']=='running'">
                        <li class="dropdown-header"><i class="fa fa-sign-in"></i> Connect</li>
                        <li><a t-attf-href="http://{{bu['domain']}}/">Home</a></li>
                        <li><a t-attf-href="http://{{bu['domain']}}/?db={{bu['real_dest']}}-all">All</a></li>
                        <li><a t-attf-href="http://{{bu['domain']}}/?db={{bu['real_dest']}}-base">Base</a></li>
                    </t>
                    <li class="dropdown-header"><i class="fa fa-hand-o-right"></i> Actions</li>
                    <li t-if="bu['result']=='skipped'">
                        <a href="#" class="runbot-rebuild" t-att-data-runbot-build="bu['id']">Force Build <i class="fa fa-level-up"></i></a>
                    </li>
                    <li t-if="bu['result']!='skipped' and bu['state']!='done'">
                        <a href="#" class="runbot-force-kill" title="TODO: backend">Kill</a>
                    </li>
                    <li t-if="bu['state'] in ['done','running'] and bu_index==0">
                        <a href="#" class="runbot-rebuild" t-att-data-runbot-build="bu['id']">Rebuild <i class="fa fa-refresh"/></a>
                    </li>
                    <li class="dropdown-header"><i class="fa fa-github"/> Links</li>
                    <li><a t-attf-href="/runbot/build/{{bu['id']}}"> Go to build</a></li>
                    <li><a t-attf-href="{{br['branch'].branch_url}}" target="_new" title="Branch or Pull">Code Review</a></li>
                    <li><a t-attf-href="https://{{repo.base}}/commit/{{bu['name']}}">Commit</a></li>
                    <li><a t-attf-href="https://{{repo.base}}/compare/{{br['branch'].branch_name}}">Compare</a></li>
                    <li class="dropdown-header"><i class="fa fa-file-text-o"/> Logs</li>
                    <li t-if="bu['host']"><a t-attf-href="http://{{bu['host']}}/runbot/static/build/#{bu['real_dest']}/logs/job_10_test_base.txt">Image Build</a></li>
                    <li t-if="bu['host']"><a t-attf-href="http://{{bu['host']}}/runbot/static/build/#{bu['real_dest']}/logs/job_20_test_all.txt">Run Logs</a></li>
                    <li><a t-attf-href="/runbot/build/{{bu['id']}}">Resumed</a></li>
                </ul>
            </div>
            </div>
        </template>

        <!-- TODO: Position properly it brakes navbar layout.
             as it was.
             -->
        <template id="vauxooci.filters" name="Search template">
            <form class="navbar-form form-inline">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                  Filter <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu">
                  <li t-if="filters['pending']=='0'"><a t-att-href="qu(pending=1)">Pending</a></li>
                  <li t-if="filters['pending']=='1'"><a t-att-href="qu(pending='0')"><i class="fa fa-check"/> Pending</a></li>
                  <li t-if="filters['testing']=='0'"><a t-att-href="qu(testing=1)">Testing</a></li>
                  <li t-if="filters['testing']=='1'"><a t-att-href="qu(testing='0')"><i class="fa fa-check"/> Testing</a></li>
                  <li t-if="filters['running']=='0'"><a t-att-href="qu(running=1)">Running</a></li>
                  <li t-if="filters['running']=='1'"><a t-att-href="qu(running='0')"><i class="fa fa-check"/> Running</a></li>
                  <li t-if="filters['done']=='0'"><a t-att-href="qu(done=1)">Done</a></li>
                  <li t-if="filters['done']=='1'"><a t-att-href="qu(done='0')"><i class="fa fa-check"/> Done</a></li>
                  <li class="divider"></li>
                  <li t-att-class="'active' if limit=='100' else ''"><a t-att-href="qu(limit=100)">Show last 100</a></li>
                  <li t-att-class="'active' if limit=='1000' else ''"><a t-att-href="qu(limit=1000)">Show last 1000</a></li>
                  <li t-att-class="'active' if limit=='10000' else ''"><a t-att-href="qu(limit=10000)">Show last 10000</a></li>
                </ul>
            </form>
        </template>
        <template id="vauxooci.input_search" name="Search template">
          <t t-if="repo">
            <form role="search" t-att-action="qu(search='')" method="get">
                <div class="form-group label-floating is-empty">
                    <div class="input-group">
                        <span class="input-group-btn">
                            <button type="button" class="btn btn-primary">
                                <i class="material-icons">search</i>
                            </button>
                        </span>
                        <label for="search0" class="control-label">Enter a search criteria</label>
                        <input type="text" name="search" id="search0" t-att-value="search" class="form-control"/>
                        <span class="help-block">criteria id, branch or pull requests</span>
                    </div>
                </div>
            </form>
          </t>
        </template>
        <template id="vauxooci.search" name="Search template">
          <t t-if="repo">
            <form class="navbar-form navbar-left" role="search" t-att-action="qu(search='')" method="get">
                <div class="form-group label-floating input-group">
                    <span class="input-group-btn"><i class="material-icons">search</i></span>
                    <input type="search" name="search" id="search0"
                           t-att-value="search" class="form-control col-sm-8"/>
                    <span class="help-block">criteria id, branch or pull requests</span>
                </div>
            </form>
          </t>
        </template>
        <template id="vauxooci.dropdown_repositories" name="Dropdown for repositories">
            <div>
                <div class="btn-group">
                <a href="#" class="btn btn-fab btn-info dropdown-toggle" data-toggle="dropdown">
                    <i class="material-icons">more_vert</i>
                </a>
                <ul class="dropdown-menu">
                    <t t-foreach='repos' t-as='re'>
                        <li><a t-attf-href="/runbot/repo/{{slug(re)}}"><t t-esc="re.base"/></a></li>
                    </t>
                </ul>
                </div>
            </div>
        </template>
        <template id="runbot.inherits_branch_in_menu" inherit_id="website.layout" name="Inherits Show top 5 branches in menu">
            <xpath expr="//div[@class='navbar-header']" position="replace">
                <!--
                <t t-call="vauxooci.search"/>
                -->
            </xpath>
            <xpath expr="//ul[@id='top_menu']" position="after">
                <t t-if="repo">
                    <p class="navbar-text"> <b><t t-esc="repo.name"/></b></p>
                </t>
            </xpath>
            <xpath expr="//t[@t-foreach=&quot;website.menu_id.child_id&quot;][@t-as=&quot;submenu&quot;]" position="replace">
        <!--
                <t t-if="repos" >
                     <t t-foreach="repos[:5]" t-as="re">
                         <li><a t-attf-href="/runbot/repo/{{slug(re)}}?search={{request.params.get('search', '')}}"><i class='fa fa-github' /> <t t-esc="re.name.split(':')[1]"/></a></li>
                     </t>
                </t>
        -->
            </xpath>
        </template>
        <template id="vauxooci.info_modal" name="Info">
            <div class="modal fade" id="info_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">x</span></button>
                            <h4 class="modal-title" id="myModalLabel">General Status</h4>
                        </div>
                        <div class="modal-body">
                            <t  t-foreach="host_stats" t-as="hs">
                            <p class="lead text-center">
                                <span class="label label-default">
                                    <t t-esc="hs['host']"/>: <t t-esc="hs['testing']"/> testing, <t t-esc="hs['running']"/> running
                                </span>&amp;nbsp;
                            </p>
                            </t>
                        </div>
                        <div class="modal-footer">
                            <span class="label label-info">Pending: <t t-esc="pending_total"/></span>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        <template id="vauxooci.build_body" name="Row on Buld table">
            <div t-attf-class="panel panel-{{ klass }}">
                <div class="panel-heading">
                    <div class="row">
                        <t t-call="runbot.build_name"/>
                        <t t-call="runbot.build_button"/>
                    </div>
                </div>
                <div class="panel-body">
                    <p t-esc="bu['subject']"/>
                </div>
                <div class="panel-footer">
                    <small t-if="not hide_time"> age <t t-esc="bu['job_age']"/> time <t t-esc="bu['job_time']"/></small>
                    <small><b>built on </b><t t-esc="bu['host']"/></small>
                </div>
            </div>
        </template>
        <template id="vauxooci.build_row" name="Row on Buld table">
            <div class="row">
                <section t-foreach="branches" t-as="br">
                    <div class="row">
                        <t t-if="br['builds'] and br['builds'][0]['result'] == 'ko'"><t t-set="klass_p">danger</t></t>
                        <t t-if="br['builds'] and br['builds'][0]['result'] == 'warn'"><t t-set="klass_p">warning</t></t>
                        <t t-if="br['builds'] and br['builds'][0]['result'] == 'ok'"><t t-set="klass_p">success</t></t>
                        <t t-if="br['builds'] and br['builds'][0]['result'] == 'skipped'"><t t-set="klass_p">default</t></t>
                        <t t-if="br['builds'] and br['builds'][0]['result'] == 'killed'"><t t-set="klass_p">killed</t></t>
                        <t t-if="br['builds'] and br['builds'][0]['state']=='testing'"><t t-set="klass_p">info</t></t>
                        <t t-if="br['builds'] and br['builds'][0]['state']=='running'"><t t-set="button_active_klass_p"></t></t>
                        <t t-if="br['builds'] and br['builds'][0]['state']!='running'"><t t-set="button_active_klass_p">disabled</t></t>
                        <div class="container-fluid">
                            <div class="col-md-10 col-md-offset-1 col-xs-12">
                                <div class="btn-group btn-group-justified">
                                    <a t-attf-class="btn btn-raised btn-{{klass_p}} {{button_active_klass_p}}"
                                        target="_new"
                                        t-attf-href="/runbot/#{repo.id}/#{br['branch'].branch_name}"
                                        title="Quick Connect last built">
                                       <t t-esc="br['builds'][0]['state']"/> <b
                                           t-esc="br['branch'].branch_name"/>
                                       age <t
                                           t-esc="br['builds'][0]['job_age']"/>
                                        <i class="material-icons md-18">call_made</i>
                                    </a>
                                    <a class="btn btn-raised">
                                        <i t-if="not br['branch'].sticky" class="material-icons">call_merge</i>
                                        <i t-if="br['branch'].sticky" class="material-icons" style="color: #f0ad4e">star</i>
                                    </a>
                                    <a class="btn btn-raised">
                                        <i class="material-icons" id="br['branch'].branch_name">control_point</i>
                                    </a>
                                    <a class="btn btn-raised"
                                        t-attf-href="{{br['branch'].branch_url}}"
                                        target="_new"
                                        title="Branch where this source code is pulled from">
                                        <i class="material-icons md-18">code</i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="container-fluid">
                            <t t-foreach="br['builds']" t-as="bu">
                                <t t-if="bu['state']=='pending'"><t t-set="klass">default</t></t>
                                <t t-if="bu['state']=='testing'"><t t-set="klass">info</t></t>
                                <t t-if="bu['state'] in ['running','done'] and bu['result'] == 'ko'"><t t-set="klass">danger</t></t>
                                <t t-if="bu['state'] in ['running','done'] and bu['result'] == 'warn'"><t t-set="klass">warning</t></t>
                                <t t-if="bu['state'] in ['running','done'] and bu['result'] == 'ok'"><t t-set="klass">success</t></t>
                                <t t-if="bu['state'] in ['running','done'] and bu['result'] == 'skipped'"><t t-set="klass">default</t></t>
                                <t t-if="bu['state'] in ['running','done'] and bu['result'] == 'killed'"><t t-set="klass">killed</t></t>
                                <div t-attf-class="col-md-3 col-lg-3 {{klass}}">
                                    <t t-call="vauxooci.build_body"/>
                                </div>
                            </t>
                        </div>
                    </div>
                </section>
            </div>
        </template>
        <template id="vauxooci.info" name="Info">
            <div>
                <div class="btn-group">
                    <a type="button" class="btn btn-fab btn-info" data-toggle="modal" href="#" data-target="#info_modal">
                        <i class="material-icons">info</i>
                    </a>
                </div>
            </div>
        </template>
        <template id="vauxooci.builds" name="Builds Body">
            <t t-if="repo">
                <div class="row" style="position: fixed; margin-top: -33px;z-index: 5000">
                    <div class="row">
                    <t class="col-xs-2 col-md-2 col-md-offset-10 col-xs-offset-10" t-call="vauxooci.info"/>
                    </div>
                    <div class="row">
                    <t class="col-xs-2 col-md-2 col-md-offset-10 col-xs-offset-10" t-call="vauxooci.dropdown_repositories"/>
                    </div>
                </div>
                <t t-call="vauxooci.input_search"/>
            </t>
            <div class="container-fluid">
                <div class="row">
                    <div class='col-md-12'>
                    <div class="panel panel-default">
                        <t t-if="not repo">
                            <div class="panel-body">
                               <h1>No Repository yet.</h1>
                            </div>
                        </t>
                        <t t-call="vauxooci.build_row"/>
                    </div>
                    </div>
                </div>
            </div>
        </template>
        <template inherit_id="runbot.repo" id="vauxooci.repo">
            <xpath expr="//t[@t-call='website.layout']" position="replace">
            <t t-call='website.layout'>
                <t t-set="head">
                    <t t-if="refresh">
                        <meta http-equiv="refresh" t-att-content="refresh"/>
                    </t>
                    <style>
                      .killed {
                        background-color: #aaa;
                      }
                    </style>
                </t>
                <t t-call="vauxooci.info_modal"/>
                <t t-call="vauxooci.builds"/>
            </t>
            </xpath>
        </template>
    </data>
</openerp>

